# 8bit音乐制作器 - 新布局规划

## 整体布局

```
┌─────────────────────────────────────────────────────────┐
│  菜单栏（文件、编辑、播放、帮助）                          │
├─────────────────────────────────────────────────────────┤
│  工具栏（播放控制、BPM设置、节拍器）                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │  主旋律编辑器（顶部，较大区域）                    │  │
│  │  ┌───────────────────────────────────────────┐  │  │
│  │  │  音高滑块（大，可滑动试听）                │  │  │
│  │  └───────────────────────────────────────────┘  │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐        │  │
│  │  │ 时长选择 │ │ 波形选择 │ │ 添加按钮 │        │  │
│  │  └──────────┘ └──────────┘ └──────────┘        │  │
│  └─────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │  序列编辑器（下方，可滚动）                      │  │
│  │  ┌───────────────────────────────────────────┐  │  │
│  │  │  主旋律序列（显示音符块）                  │  │  │
│  │  └───────────────────────────────────────────┘  │  │
│  │  ┌───────────────────────────────────────────┐  │  │
│  │  │  低音序列（显示节拍块）                    │  │  │
│  │  └───────────────────────────────────────────┘  │  │
│  │  ┌───────────────────────────────────────────┐  │  │
│  │  │  打击乐序列（显示节拍块）                  │  │  │
│  │  └───────────────────────────────────────────┘  │  │
│  │  [添加新轨道按钮]                               │  │
│  └─────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │  时间轴/网格（底部，显示节拍网格）               │  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 功能模块

### 1. 主旋律编辑器（顶部区域）

**音高选择滑块**：
- 大滑块（高度至少100px）
- 范围：MIDI 0-127
- 实时显示音名（C4, D4等）
- 滑动时实时试听（播放当前音高）
- 可以点击滑块任意位置快速跳转

**时长选择**：
- 按节拍选择：1/4拍、1/2拍、1拍、2拍、4拍
- 也可以显示秒数（根据BPM计算）
- 下拉菜单或按钮组

**波形选择**：
- 下拉菜单：方波、三角波、锯齿波、正弦波
- 默认方波

**添加按钮**：
- 大按钮："添加音符"
- 点击后添加到主旋律序列末尾
- 自动对齐到网格

### 2. 序列编辑器（中间区域）

**主旋律序列**：
- 显示音符块（彩色矩形）
- 显示音名标签
- 可以点击选中
- 可以拖拽调整位置（对齐到网格）
- 可以删除

**低音序列**：
- 显示节拍块（不是音符，是节拍事件）
- 可以选择音高（但概念是"低音线"）
- 显示时长
- 可以添加、删除、调整

**打击乐序列**：
- 显示节拍块
- 可以选择打击乐类型（底鼓、军鼓、踩镲等）
- 显示时长
- 可以添加、删除、调整

**网格对齐**：
- 所有序列共享同一时间轴
- 显示节拍网格线（1/4拍、1拍、小节）
- 所有块自动对齐到网格

### 3. 时间轴/网格（底部）

- 显示节拍标记（1, 2, 3, 4...）
- 显示小节线
- 显示播放头
- 可以缩放

## 数据模型调整

### 主旋律轨道
- 使用Note对象
- 有音高、时长、波形

### 低音轨道
- 使用BassEvent对象（类似Note但概念不同）
- 有音高、时长、波形

### 打击乐轨道
- 使用DrumEvent对象
- 有类型（底鼓、军鼓等）、时长
- 没有音高概念

## 操作流程

1. **添加主旋律音符**：
   - 滑动音高滑块，试听音高
   - 选择时长（1/4拍、1拍等）
   - 点击"添加音符"
   - 自动添加到序列末尾，对齐到网格

2. **添加低音**：
   - 点击低音序列的"添加"按钮
   - 选择音高和时长
   - 添加低音事件

3. **添加打击乐**：
   - 点击打击乐序列的"添加"按钮
   - 选择打击乐类型和时长
   - 添加打击乐事件

4. **编辑**：
   - 点击序列中的块可以选中
   - 可以拖拽调整位置（对齐到网格）
   - 可以删除

## 技术实现要点

1. **实时试听**：
   - 滑块滑动时生成当前音高的短音频
   - 使用AudioEngine播放
   - 需要防抖（避免播放太频繁）

2. **网格对齐**：
   - 所有时间计算基于节拍
   - 转换为秒数用于播放
   - 显示时按节拍对齐

3. **序列显示**：
   - 使用QGraphicsView显示序列
   - 每个块是一个QGraphicsItem
   - 支持拖拽和对齐

