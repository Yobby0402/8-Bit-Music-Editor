# 音轨重构实现方案

## 问题根源分析

当前问题：
1. 所有音符叠加在第一个轨道上
2. TrackGroup管理混乱，可能所有音符都被添加到第一个TrackGroup

## 重构方案：每个轨道一个独立控件

### 核心设计

```
GridSequenceWidget
├── QGraphicsScene
    ├── 网格线（共享）
    ├── 播放头（共享）
    ├── TrackWidget[0] (轨道0，独立控件)
    │   ├── 位置: y = 0 * 60 + 20
    │   ├── 标签
    │   ├── 勾选框
    │   ├── 轨道线
    │   └── 音符块列表（只包含该轨道的音符）
    ├── TrackWidget[1] (轨道1，独立控件)
    │   ├── 位置: y = 1 * 60 + 20
    │   └── ...
    └── ...
```

### 关键实现点

1. **每个TrackWidget完全独立**
   - 只管理自己轨道的音符
   - 位置由track_index决定
   - 不共享任何状态

2. **时间同步机制**
   - 所有TrackWidget共享pixels_per_beat和bpm
   - 音符x坐标计算：`x = 100 + start_beats * pixels_per_beat`
   - 所有轨道时间轴完全同步

3. **音符分配逻辑**
   - 使用track_index来查找对应的TrackWidget
   - 确保每个音符被添加到正确的TrackWidget
   - 清除旧轨道的音符块

### 实现步骤

1. 简化TrackGroup，确保每个轨道独立
2. 修复音符分配逻辑，使用track_index而不是id(track)
3. 添加调试信息，确保每个音符被正确分配

