# 音轨重构实现计划

## 当前问题
1. 所有音符叠加在第一个轨道上
2. TrackGroup管理混乱
3. 轨道元素创建逻辑复杂

## 重构方案：每个轨道一个独立控件

### 核心思路
- 每个轨道是一个独立的 `TrackWidget` (继承自 QGraphicsItemGroup)
- 每个 TrackWidget 完全独立管理自己的所有元素
- 所有 TrackWidget 共享时间轴（pixels_per_beat, bpm）

### 实现步骤

#### 第一步：简化TrackGroup
- 确保每个TrackGroup只管理一个轨道的元素
- 清除旧的音符块引用，避免混乱

#### 第二步：修复轨道创建逻辑
- 在 `_incremental_update_tracks_and_blocks` 中，确保每个轨道都有对应的TrackGroup
- 当轨道变化时，清除旧轨道的音符块

#### 第三步：修复音符分配
- 确保音符被添加到正确的TrackGroup
- 使用 track_index 来确保正确性

### 关键修复点

1. **清除旧轨道的音符块**
   - 当TrackGroup的track引用改变时，清除旧的音符块
   - 确保每个TrackGroup只包含当前轨道的音符

2. **确保TrackGroup列表同步**
   - TrackGroup列表必须与tracks列表一一对应
   - 删除轨道时，同时删除对应的TrackGroup

3. **音符块分配**
   - 使用 `track_index` 而不是 `id(track)` 来查找TrackGroup
   - 确保每个音符块被添加到正确的TrackGroup

