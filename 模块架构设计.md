# 8bit音乐制作器 - 模块架构设计

## 模块概览

建议采用**8个核心模块** + **工具模块**的架构，每个模块职责清晰，便于开发和维护。

---

## 一、核心模块（8个）

### 1. **AudioEngine（音频引擎模块）**
**职责**：音频生成、混合、播放的核心引擎

**主要功能**：
- 波形数据生成
- 多声道音频混合
- 实时音频播放
- 音频缓冲区管理
- 采样率转换

**关键类**：
```python
class AudioEngine:
    - generate_waveform()
    - mix_channels()
    - play_audio()
    - stop_audio()
    - set_sample_rate()
```

**依赖**：NumPy, Pygame/PyAudio

---

### 2. **WaveformGenerator（波形生成器模块）**
**职责**：各种波形的生成算法

**主要功能**：
- 方波生成（可调占空比）
- 三角波生成
- 锯齿波生成
- 正弦波生成
- 噪声生成（白噪声、粉噪声）
- 波形参数控制

**关键类**：
```python
class WaveformGenerator:
    - generate_square()
    - generate_triangle()
    - generate_sawtooth()
    - generate_sine()
    - generate_noise()
    
class WaveformParams:
    - frequency
    - amplitude
    - duty_cycle
    - phase
```

**依赖**：NumPy

---

### 3. **EnvelopeProcessor（包络处理模块）**
**职责**：音量包络和音高包络的处理

**主要功能**：
- ADSR包络生成
- 音高包络生成
- 包络曲线计算
- 包络参数管理

**关键类**：
```python
class EnvelopeProcessor:
    - apply_adsr()
    - apply_pitch_envelope()
    - generate_envelope_curve()
    
class ADSRParams:
    - attack_time
    - decay_time
    - sustain_level
    - release_time
```

**依赖**：NumPy

---

### 4. **Sequencer（序列器模块）**
**职责**：音乐序列的编辑、管理和播放控制

**主要功能**：
- 音符数据管理
- 多轨道管理
- 时间轴管理
- 播放控制（播放、暂停、停止、循环）
- 节拍和BPM管理
- 量化处理

**关键类**：
```python
class Sequencer:
    - add_note()
    - remove_note()
    - get_notes_at_time()
    - play()
    - pause()
    - stop()
    - set_bpm()
    
class Track:
    - name
    - waveform_type
    - volume
    - notes: List[Note]
    - enabled
    
class Note:
    - pitch (MIDI)
    - start_time
    - duration
    - velocity
    - waveform
    - envelope_params
```

**依赖**：AudioEngine, WaveformGenerator, EnvelopeProcessor

---

### 5. **EffectProcessor（效果处理模块）**
**职责**：各种音频效果的处理

**主要功能**：
- 滤波器（低通、高通、带通）
- 调制效果（颤音、颤音、环形调制）
- 时间效果（延迟、回声）
- 动态效果（压缩器）
- 效果链管理

**关键类**：
```python
class EffectProcessor:
    - apply_filter()
    - apply_tremolo()
    - apply_vibrato()
    - apply_delay()
    - process_effect_chain()
    
class Filter:
    - type (LPF/HPF/BPF)
    - cutoff_frequency
    - resonance
    
class EffectChain:
    - effects: List[Effect]
    - enabled
```

**依赖**：NumPy

---

### 6. **ProjectManager（项目管理模块）**
**职责**：项目的保存、加载和管理

**主要功能**：
- 项目文件保存（JSON格式）
- 项目文件加载
- 项目数据验证
- 项目模板管理
- 项目历史记录（可选）

**关键类**：
```python
class ProjectManager:
    - save_project()
    - load_project()
    - create_new_project()
    - export_project()
    
class Project:
    - name
    - bpm
    - time_signature
    - tracks: List[Track]
    - metadata
```

**依赖**：Sequencer

---

### 7. **SoundEffectManager（音效管理器模块）**
**职责**：音效的创建、管理和生成

**主要功能**：
- 音效模板管理
- 音效参数化生成
- 音效库管理
- 音效预览
- 音效导出

**关键类**：
```python
class SoundEffectManager:
    - create_effect()
    - load_effect_template()
    - save_effect()
    - generate_effect_variants()
    
class SoundEffect:
    - type (jump/collect/explosion/etc)
    - parameters
    - waveform
    - duration
    
class EffectTemplate:
    - name
    - category
    - default_params
    - generator_function
```

**依赖**：WaveformGenerator, EnvelopeProcessor, AudioEngine

---

### 8. **ExportManager（导出管理器模块）**
**职责**：各种格式的导入导出

**主要功能**：
- WAV文件导出
- MIDI文件导入/导出
- OGG/MP3导出（可选）
- 音效批量导出
- 音频格式转换

**关键类**：
```python
class ExportManager:
    - export_wav()
    - export_midi()
    - import_midi()
    - export_sound_effects()
    - convert_format()
    
class ExportSettings:
    - sample_rate
    - bit_depth
    - channels
    - format
```

**依赖**：Sequencer, SoundEffectManager, SciPy/SoundFile

---

## 二、UI模块（PyQt5）

### 9. **MainWindow（主窗口模块）**
**职责**：主界面布局和窗口管理

**主要功能**：
- 窗口布局
- 菜单栏
- 工具栏
- 状态栏
- 窗口事件处理

**关键类**：
```python
class MainWindow(QMainWindow):
    - setup_ui()
    - setup_menu()
    - setup_toolbar()
    - setup_statusbar()
```

---

### 10. **PianoRollWidget（钢琴卷帘窗模块）**
**职责**：音符的可视化编辑

**主要功能**：
- 钢琴键盘显示
- 音符块显示和编辑
- 拖拽操作
- 选择操作
- 缩放和平移

**关键类**：
```python
class PianoRollWidget(QGraphicsView):
    - draw_piano_keys()
    - draw_notes()
    - handle_mouse_events()
    - handle_keyboard_events()
    
class NoteItem(QGraphicsItem):
    - note: Note
    - paint()
    - mouse_event()
```

---

### 11. **TrackListWidget（轨道列表模块）**
**职责**：轨道列表的显示和管理

**主要功能**：
- 轨道列表显示
- 轨道属性编辑
- 轨道控制（静音、独奏、音量）
- 轨道添加/删除

**关键类**：
```python
class TrackListWidget(QWidget):
    - display_tracks()
    - add_track()
    - remove_track()
    - update_track_properties()
    
class TrackItemWidget(QWidget):
    - track: Track
    - mute_button
    - solo_button
    - volume_slider
```

---

### 12. **TimelineWidget（时间轴模块）**
**职责**：时间轴的显示和控制

**主要功能**：
- 时间轴显示
- 播放头显示
- 网格显示
- 标记点显示
- 循环区域显示

**关键类**：
```python
class TimelineWidget(QWidget):
    - draw_timeline()
    - draw_playhead()
    - draw_grid()
    - handle_time_click()
```

---

### 13. **PropertyPanel（属性面板模块）**
**职责**：选中对象的属性编辑

**主要功能**：
- 音符属性编辑
- 轨道属性编辑
- 全局设置
- 波形参数编辑
- 包络参数编辑

**关键类**：
```python
class PropertyPanel(QWidget):
    - show_note_properties()
    - show_track_properties()
    - show_global_settings()
    - update_properties()
```

---

### 14. **PlaybackControls（播放控制模块）**
**职责**：播放控制界面

**主要功能**：
- 播放/暂停/停止按钮
- BPM显示和调整
- 节拍器控制
- 循环控制
- 播放位置显示

**关键类**：
```python
class PlaybackControls(QWidget):
    - play_button
    - pause_button
    - stop_button
    - bpm_spinbox
    - metronome_button
    - loop_checkbox
```

---

### 15. **SoundEffectEditor（音效编辑器模块）**
**职责**：音效编辑界面

**主要功能**：
- 音效类型选择
- 音效参数编辑
- 音效预览
- 音效库浏览
- 音效生成工具

**关键类**：
```python
class SoundEffectEditor(QWidget):
    - effect_type_selector
    - parameter_editors
    - preview_button
    - effect_library_browser
```

---

## 三、工具模块（辅助功能）

### 16. **Metronome（节拍器模块）**
**职责**：节拍器的实现

**关键类**：
```python
class Metronome:
    - start()
    - stop()
    - set_bpm()
    - tick()
```

---

### 17. **Quantizer（量化器模块）**
**职责**：音符量化处理

**关键类**：
```python
class Quantizer:
    - quantize_notes()
    - set_grid_size()
    - set_strength()
```

---

### 18. **Arpeggiator（琶音器模块）**
**职责**：琶音生成

**关键类**：
```python
class Arpeggiator:
    - generate_arpeggio()
    - set_direction()
    - set_speed()
```

---

### 19. **ChordGenerator（和弦生成器模块）**
**职责**：和弦生成和管理

**关键类**：
```python
class ChordGenerator:
    - generate_chord()
    - get_chord_notes()
    - chord_library
```

---

## 模块依赖关系图

```
MainWindow (UI)
    ├── PianoRollWidget
    ├── TrackListWidget
    ├── TimelineWidget
    ├── PropertyPanel
    ├── PlaybackControls
    └── SoundEffectEditor
         │
         ├── Sequencer
         │    ├── AudioEngine
         │    ├── WaveformGenerator
         │    ├── EnvelopeProcessor
         │    └── EffectProcessor
         │
         ├── SoundEffectManager
         │    ├── WaveformGenerator
         │    ├── EnvelopeProcessor
         │    └── AudioEngine
         │
         ├── ProjectManager
         │    └── Sequencer
         │
         └── ExportManager
              ├── Sequencer
              └── SoundEffectManager
```

---

## 模块文件结构

```
8bit_music_maker/
├── core/                          # 核心模块
│   ├── __init__.py
│   ├── audio_engine.py            # AudioEngine
│   ├── waveform_generator.py      # WaveformGenerator
│   ├── envelope_processor.py      # EnvelopeProcessor
│   ├── sequencer.py               # Sequencer
│   ├── effect_processor.py        # EffectProcessor
│   ├── project_manager.py         # ProjectManager
│   ├── sound_effect_manager.py    # SoundEffectManager
│   └── export_manager.py          # ExportManager
│
├── ui/                            # UI模块
│   ├── __init__.py
│   ├── main_window.py             # MainWindow
│   ├── piano_roll_widget.py       # PianoRollWidget
│   ├── track_list_widget.py       # TrackListWidget
│   ├── timeline_widget.py         # TimelineWidget
│   ├── property_panel.py          # PropertyPanel
│   ├── playback_controls.py       # PlaybackControls
│   └── sound_effect_editor.py     # SoundEffectEditor
│
├── utils/                         # 工具模块
│   ├── __init__.py
│   ├── metronome.py               # Metronome
│   ├── quantizer.py               # Quantizer
│   ├── arpeggiator.py             # Arpeggiator
│   └── chord_generator.py         # ChordGenerator
│
├── data/                          # 数据文件
│   ├── templates/                 # 项目模板
│   ├── sound_effects/             # 音效模板
│   └── presets/                   # 预设
│
├── main.py                        # 程序入口
└── requirements.txt               # 依赖列表
```

---

## 模块通信方式

### 1. **直接调用**
- UI模块直接调用核心模块的方法
- 简单直接，适合同步操作

### 2. **信号和槽（PyQt5）**
- UI事件通过信号槽机制传递
- 适合异步操作和事件驱动

### 3. **数据模型**
- 使用统一的数据模型（Project、Track、Note等）
- 模块通过数据模型交互

### 4. **事件总线（可选）**
- 复杂系统可以使用事件总线
- 解耦模块之间的依赖

---

## 开发顺序建议

### 第一阶段：核心功能
1. **WaveformGenerator** - 基础波形生成
2. **AudioEngine** - 音频播放
3. **Sequencer** - 基础序列器（单轨道）
4. **MainWindow + PianoRollWidget** - 基础UI

### 第二阶段：完善功能
5. **EnvelopeProcessor** - 包络处理
6. **TrackListWidget** - 多轨道支持
7. **ProjectManager** - 项目保存/加载
8. **ExportManager** - WAV导出

### 第三阶段：高级功能
9. **EffectProcessor** - 效果处理
10. **SoundEffectManager** - 音效制作
11. **ExportManager扩展** - MIDI导入导出
12. **工具模块** - 节拍器、量化器等

### 第四阶段：优化和完善
13. UI优化和美化
14. 性能优化
15. 教程和帮助系统

---

## 总结

**核心模块**：8个
- AudioEngine
- WaveformGenerator
- EnvelopeProcessor
- Sequencer
- EffectProcessor
- ProjectManager
- SoundEffectManager
- ExportManager

**UI模块**：6个
- MainWindow
- PianoRollWidget
- TrackListWidget
- TimelineWidget
- PropertyPanel
- PlaybackControls
- SoundEffectEditor

**工具模块**：4个
- Metronome
- Quantizer
- Arpeggiator
- ChordGenerator

**总计**：约18个模块

这种模块化设计的好处：
- ✅ **职责清晰**：每个模块只负责特定功能
- ✅ **易于维护**：修改某个功能不影响其他模块
- ✅ **便于测试**：可以单独测试每个模块
- ✅ **可扩展性**：容易添加新功能
- ✅ **团队协作**：不同开发者可以并行开发不同模块

