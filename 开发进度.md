# 8bit音乐制作器 - 开发进度

## 当前状态

✅ **V2 系列已完成基础音乐制作功能与稳定性打磨，软件可正常用于日常创作**

> V2 主要目标：完善和打磨「基础音乐制作能力」，包括：  
> - 序列编辑、属性编辑、MIDI 导入导出、WAV 导出  
> - UI 主题与布局优化、示波器可视化、乐谱片段库  
> - 播放线 / 播放头对齐与性能稳定性、鼓点编辑等关键 BUG 修复

⏳ **V3 系列已启动：基于 Seed 的多风格 8bit 自动配乐正在开发中（已完成首版可用生成）**

> V3 主要目标：  
> - 用类似 Minecraft 的「Seed」机制，一键生成可编辑的 8bit 音乐工程；  
> - 支持多种曲风（经典 8bit / Lofi / 战斗 / 悬疑 / 舒缓），同一 Seed 在同一风格下结果稳定可复现；  
> - 在保证“可编辑”的前提下，通过规则和参数尽量贴近真实配乐的律动与情绪。

## 已完成的功能

### 1. 核心模块 ✅

#### 数据模型 (`core/models.py`)
- ✅ Note（音符）数据模型
- ✅ Track（轨道）数据模型
- ✅ Project（项目）数据模型
- ✅ ADSRParams（包络参数）数据模型
- ✅ WaveformType（波形类型）枚举
- ✅ BassEvent、DrumEvent、DrumType（打击乐事件）
- ✅ 完整的序列化/反序列化支持（JSON格式）
- ✅ 网格格式存储（grid_index, note_value）
- ✅ BPM缩放支持（original_bpm）

#### 波形生成器 (`core/waveform_generator.py`)
- ✅ 方波生成（支持占空比调整）
- ✅ 三角波生成
- ✅ 锯齿波生成
- ✅ 正弦波生成
- ✅ 噪声生成（白噪声、粉噪声）
- ✅ MIDI音符到频率转换
- ✅ 频率到MIDI音符转换

#### 包络处理器 (`core/envelope_processor.py`)
- ✅ ADSR包络生成
- ✅ 包络应用到波形
- ✅ 音高包络生成
- ✅ 颤音效果（Vibrato）
- ✅ 颤音效果（Tremolo）

#### 音频引擎 (`core/audio_engine.py`)
- ✅ 单音符音频生成
- ✅ 轨道音频生成
- ✅ 多轨道音频混合
- ✅ 项目音频生成
- ✅ 实时音频播放（基于Pygame）
- ✅ 音频归一化（防止削波）
- ✅ 打击乐音频生成（底鼓、军鼓、踩镲、吊镲）
- ✅ BPM缩放支持
- ✅ 休止符处理

#### 序列器 (`core/sequencer.py`)
- ✅ 项目管理
- ✅ 轨道管理（添加/删除）
- ✅ 音符管理（添加/删除）
- ✅ 播放控制（播放/暂停/停止）
- ✅ BPM管理
- ✅ 节拍/秒转换
- ✅ 循环区域设置

#### 效果处理器 (`core/effect_processor.py`)
- ✅ 滤波器（低通、高通、带通）
- ✅ 延迟效果
- ✅ 颤音效果（Tremolo - 音量调制）
- ✅ 颤音效果（Vibrato - 音高调制）
- ✅ 效果链处理

#### MIDI导入导出 (`core/midi_io.py`)
- ✅ MIDI文件导入
- ✅ MIDI文件导出
- ✅ 自动提取BPM
- ✅ 多轨道支持
- ✅ 音符转换（音高、时长、力度）

### 2. UI模块 ✅

#### 主窗口 (`ui/main_window.py`)
- ✅ 窗口布局（统一编辑器 + 序列编辑器）
- ✅ 菜单栏（文件、编辑、视图、播放）
- ✅ 播放控制（播放/暂停/停止）
- ✅ 从播放线位置开始播放
- ✅ BPM设置
- ✅ 主音量控制
- ✅ 状态栏
- ✅ 项目文件操作（新建/打开/保存/另存为）
- ✅ WAV导出功能
- ✅ MIDI导入导出功能
- ✅ 键盘快捷键支持
- ✅ 属性面板（浮动窗口，默认隐藏）
- ✅ 创建音轨时自定义名称

#### 统一编辑器 (`ui/unified_editor_widget.py`)
- ✅ 波形选择（方波、三角波、锯齿波、正弦波）
- ✅ 音轨类型选择（主旋律、低音）
- ✅ 钢琴键盘（9个八度，C0-C8）
- ✅ 打击乐按钮（底鼓、军鼓、踩镲、吊镲）
- ✅ 拍数选择（1/4、1/2、1、2、4拍）
- ✅ 休止符按钮
- ✅ 实时预览（悬停播放）
- ✅ 低音预览使用三角波

#### 序列编辑器 (`ui/grid_sequence_widget.py`)
- ✅ 多轨道显示
- ✅ 网格对齐（1/4拍）
- ✅ 音符块显示（按波形颜色区分）
- ✅ 音符拖拽（限制在当前轨道）
- ✅ 音符吸附到网格
- ✅ 多选功能（框选）
- ✅ 键盘删除（Delete/Backspace）
- ✅ 全选功能（Ctrl+A）
- ✅ 重叠检测和位置交换
- ✅ 水平滚动（Shift + 滚轮）
- ✅ 水平缩放（Alt + 滚轮）
- ✅ 播放头显示
- ✅ 播放线点击和拖动定位
- ✅ 播放线自动吸附到1/4拍网格
- ✅ 网格线自适应显示（根据缩放级别）
- ✅ 增量更新（避免刷新时空白闪烁）
- ✅ 高亮显示目标音轨
- ✅ 动态调整场景大小

#### 属性面板 (`ui/property_panel_widget.py`)
- ✅ 音符属性编辑（音高、时长、力度、波形）
- ✅ ADSR包络编辑
- ✅ 时长按1/4拍步进
- ✅ 轨道效果编辑（滤波器、延迟、颤音）
- ✅ 实时更新序列编辑器
- ✅ 调节时长时自动调整后续音符位置

#### 节拍器 (`ui/metronome_widget.py`)
- ✅ 可视化节拍器（4个节拍指示器）
- ✅ 开启/关闭开关
- ✅ BPM显示
- ✅ 水平布局
- ✅ 播放时同步

#### 钢琴键盘 (`ui/piano_keyboard_widget.py`)
- ✅ 9个八度选择（C0-C8）
- ✅ 黑白键交错布局
- ✅ 实时预览（悬停播放）
- ✅ 点击添加音符
- ✅ 休止符按钮集成

#### 时间轴 (`ui/timeline_widget.py`)
- ✅ 时间轴显示
- ✅ 小节线和拍线
- ✅ 播放头显示
- ✅ BPM显示

### 3. 功能特性 ✅

#### 音符编辑
- ✅ 点击钢琴键盘添加音符
- ✅ 拖拽音符调整位置
- ✅ 音符吸附到1/4拍网格
- ✅ 多选和批量删除
- ✅ 属性面板实时编辑
- ✅ 调节时长时后续音符自动移动

#### 播放功能
- ✅ 播放/暂停/停止
- ✅ 从播放线位置开始播放
- ✅ 播放线点击定位
- ✅ 播放线拖动定位
- ✅ 播放线自动吸附到1/4拍网格
- ✅ 播放头实时显示
- ✅ BPM调整
- ✅ 主音量控制
- ✅ 节拍器同步
- ✅ 循环播放（可选）

#### 导入导出
- ✅ 项目保存/加载（JSON格式）
- ✅ WAV文件导出
- ✅ MIDI文件导入
- ✅ MIDI文件导出

#### 键盘快捷键
- ✅ Space - 播放/暂停
- ✅ Ctrl+S - 保存
- ✅ Ctrl+O - 打开
- ✅ Ctrl+N - 新建
- ✅ Ctrl+A - 全选
- ✅ Ctrl+E - 导出WAV
- ✅ Delete/Backspace - 删除选中音符
- ✅ Ctrl+. - 停止

### 4. 项目配置 ✅

- ✅ 项目目录结构
- ✅ requirements.txt（依赖管理）
- ✅ README.md（项目说明）
- ✅ .gitignore（版本控制）

### 5. V2 系列新增 / 改进功能（概览） ✅

#### UI / 主题与布局
- ✅ 全局 UI 主题系统（`Theme` / `ThemeManager`），支持：
  - 前景色 / 背景色即时生效
  - 渐变背景（线性 / 放射）和统一按钮字体
  - 软件字体与按钮字体分别设置，立即刷新全局 UI
- ✅ 设置对话框统一入口（显示 / 编辑 / 示波器 / 快捷键 / 其它）
- ✅ 钢琴键盘高度与布局重构：不同分辨率下白键不再被截断，自动缩放
- ✅ 右侧属性面板与乐谱面板 Dock 统一宽度，切换 Tab 时界面不再抖动
- ✅ 轨道列表与右侧网格精准对齐，少量轨道 / 多轨道时都保持对齐

#### 示波器 / 播放相关
- ✅ 示波器波形重写：
  - 去除多重定时器，统一由主播放定时器驱动，彻底消除闪烁 / 抖动
  - 固定时间窗口与采样点数，波形在水平方向填充整个区域
  - 正确的时间方向（从左到右），并与红色播放线对齐
  - 重叠音符优先级规则：先比较 `start_time`（晚的优先），再比较 `pitch`（高音优先）
- ✅ 播放线 / 播放头同步：
  - 播放线与音符节拍对齐，长时间播放不再「越跑越快」
  - 增加播放线刷新率设置，用户可在设置中调整视觉流畅度

#### MIDI / 音频生成
- ✅ MIDI 导入恢复为「忠实还原原始 MIDI」：
  - 每条 MIDI 轨道各自维护 `set_tempo`，不再强行套用全局 BPM
  - 不在导入时强制对齐网格，不做「自动防重叠」处理
- ✅ 音频引擎生成逻辑改进：
  - 以 Note 的 `start_time` / `duration`（秒）为唯一时间源
  - 避免再次按 BPM 进行缩放，保证听感与网格上位置一致

#### 序列编辑 / 鼓点与乐谱片段
- ✅ 鼓点事件（DrumEvent）多选 / 删除逻辑修复：不再出现删除无效或 UI 不刷新的问题
- ✅ 轨道批量属性修改（波形 / 力度 / 占空比）即时生效，并正确刷新 UI
- ✅ 乐谱片段库（Score Library）：
  - 支持从当前选区创建片段、应用到当前轨道、重命名 / 分组管理
  - 新增「试听」按钮，可在不改动工程的前提下播放选中片段（临时轨道预览）
  - 统一按钮尺寸与样式，风格与属性面板一致

---

## 项目结构

```
8bit/
├── core/                          # 核心模块
│   ├── __init__.py
│   ├── models.py                  # 数据模型
│   ├── waveform_generator.py     # 波形生成器
│   ├── envelope_processor.py     # 包络处理器
│   ├── audio_engine.py           # 音频引擎
│   ├── sequencer.py              # 序列器
│   ├── effect_processor.py       # 效果处理器
│   ├── midi_io.py                # MIDI导入导出
│   └── track_events.py           # 轨道事件类型
├── ui/                            # UI模块
│   ├── __init__.py
│   ├── main_window.py            # 主窗口
│   ├── unified_editor_widget.py  # 统一编辑器
│   ├── grid_sequence_widget.py  # 序列编辑器
│   ├── property_panel_widget.py # 属性面板
│   ├── metronome_widget.py      # 节拍器
│   ├── piano_keyboard_widget.py # 钢琴键盘
│   ├── timeline_widget.py       # 时间轴
│   └── ...                       # 其他UI组件
├── main.py                        # 程序入口
├── requirements.txt               # 依赖列表
└── README.md                      # 项目说明
```

## 技术栈

- **Python 3.10+**
- **PyQt5** - GUI框架
- **NumPy** - 数值计算和波形生成
- **SciPy** - 音频处理（WAV文件）
- **Pygame** - 音频播放
- **mido** - MIDI文件处理

### 6. V3：基于 Seed 的多风格自动生成（首版已实现，持续打磨中） ⏳

#### 核心生成逻辑（`core/seed_music_generator.py`）
- ✅ `get_rng_from_seed(seed)`：统一的随机源工具，同一 Seed 在同一版本下生成结果完全一致
- ✅ `SeedMusicStyle` 枚举：支持 `CLASSIC_8BIT / LOFI / BATTLE / SUSPENSE / CALM` 五种曲风
- ✅ `StyleParams`：按风格集中配置波形、占空比、ADSR、鼓力度比例等参数，方便扩展更多曲风
- ✅ `generate_simple_project_from_seed(seed, length_bars, style)`：
  - 按风格决定 BPM（战斗更快、舒缓更慢、悬疑中速偏快）
  - 为同一 Seed 生成包含 **主旋律 / 低音 / 和声 / 鼓点** 的多轨工程
  - 为不同风格设置独立的节奏/和声逻辑：  
    - 战斗：更高 BPM、短促重复音、密集鼓点与推动感低音  
    - 悬疑：日式小调（类似 In/Hirajoshi / Phrygian）、强拍“危险音”、半音抖动与静默小节  
    - 舒缓：大调为主、稳定和声走向、时值更长、力度更柔和

#### 曲风细化与效果
- ✅ 悬疑风格：  
  - 使用接近日式和风小调的音阶，突出 1、♭2、4、5、♭7 等度数，整体抬到中高音区避免发闷  
  - 强拍更容易落在“危险音”（♭2 / ♭6 / ♭7），弱拍带少量半音邻音抖动  
  - 主旋律采用「三连击」式短促节奏，时值覆盖整小节，避免只在前半小节响、后半空掉  
  - 设计「恐怖和弦模板」与安静小节（部分轨道静音、长音悬挂），营造压抑与空间感  
  - 主旋律轨添加高通滤波 + 颤音（Vibrato），更尖锐、更不稳定
- ✅ 战斗风格：  
  - 提高 BPM，主旋律使用双触发/多次短促触发，鼓点密集（每拍都有鼓）  
  - 低音以稳定强拍为主，加强推进感
- ✅ 舒缓风格：  
  - 使用大调与稳定和声进行（如 I–IV–V–I 的变体），时值更长  
  - 轨道整体音量 / 力度更柔和，鼓点稀疏，仅做基础节奏

#### UI 集成（`ui/main_window.py` 等）
- ✅ 新增「从 Seed 生成音乐」对话框：  
  - 选择曲风（枚举 `SeedMusicStyle`）  
  - 输入 Seed 文本、指定小节数  
  - 一键生成完整 Project 并载入到当前工程
- ✅ BPM 与全局 UI 联动：  
  - Seed 生成后自动刷新 `bpm_spinbox`、节拍器、序列编辑器、统一编辑器、属性面板、示波器等  
  - 不再固定显示为 120 BPM，能够反映不同曲风的默认速度

## 待实现功能（V3 及以后）

### V3：基于 Seed 的音乐自动生成（当前规划）

> 目标：类似 Minecraft 的世界生成，用一个 seed 自动生成一段可编辑的 8bit 简单音乐。

1. ⏳ **Seed 随机源与入口（核心已完成，后续继续扩展）**
- ✅ 已实现统一的 `get_rng_from_seed(seed)` 与主窗口入口 / 对话框；
- ⏳ 后续可以增加：最近使用 Seed 列表、Seed 收藏 / 命名、按风格批量试听等。

2. ⏳ **音乐结构生成器（MusicStructure）**
   - 根据 seed 生成基础结构：BPM、调式（如 C 大调 / A 小调）、总小节数。
   - 为每个小节生成简单的和声区域 / 功能（例如 I–IV–V–I 的若干变体）。

3. ⏳ **模式库 / 片段库复用（与现有乐谱片段更深度结合）**
   - 设计一组可复用的短乐句 / 节奏 pattern（主旋律 / 低音 / 鼓点），与现有「乐谱片段库」理念统一。
   - 生成时由 seed 驱动 pattern 选择与简单变形（移调、节奏微调），而不是逐音完全随机。

4. ⏳ **声部生成器（目前已有单文件实现，后续可拆分为独立组件）**
- 当前所有声部生成集中在 `generate_simple_project_from_seed` 内部；
- 后续可抽象为：`MelodyGenerator` / `BassGenerator` / `HarmonyGenerator` / `DrumGenerator`，便于单独调参与测试。

5. ⏳ **与 Sequencer / Project 集成**
- 目前已可以直接生成 `Project` 并用于编辑 / 导出；
- 后续可以增加：在已有工程中「追加一段 Seed 段落」、或将 Seed 生成的轨道自动与手动创作轨道混合管理。

### 其他中长期功能（暂缓）

1. ⏳ **和弦编辑器** - 快速添加和弦
2. ⏳ **琶音器** - 自动生成琶音
3. ⏳ **自动化（Automation）** - 参数自动化曲线
4. ⏳ 音效库系统
5. ⏳ 项目模板
6. ⏳ 更多效果（压缩器、环形调制等）
7. ⏳ MIDI 键盘支持

## 已知问题

- 无

## 贡献

欢迎提交 Issue 和 Pull Request！
