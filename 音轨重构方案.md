# 音轨重构方案

## 问题分析
当前问题：
1. 所有音符叠加在第一个轨道上
2. TrackGroup架构没有正确工作
3. 轨道元素管理混乱

## 重构方案

### 架构设计
采用"每个轨道一个独立控件"的架构，类似Adobe Premiere Pro：

```
GridSequenceWidget (主容器)
├── QGraphicsScene
    ├── TimelineWidget (时间轴，共享)
    ├── TrackWidget[0] (轨道0)
    │   ├── TrackHeader (标签、勾选框)
    │   ├── TrackContent (音符区域)
    │   └── TrackLine (轨道线)
    ├── TrackWidget[1] (轨道1)
    │   ├── TrackHeader
    │   ├── TrackContent
    │   └── TrackLine
    └── ...
```

### 核心类设计

#### 1. TrackWidget (QGraphicsItemGroup)
每个轨道是一个独立的TrackWidget，包含：
- track: Track对象引用
- track_index: 轨道索引
- header: 轨道头部（标签、勾选框）
- content_area: 内容区域（音符块）
- line: 轨道线

**关键特性**：
- 独立管理自己的音符块
- 共享时间轴（通过pixels_per_beat和bpm）
- 可以独立调整高度（未来功能）
- 位置由track_index决定（y = track_index * track_height）

#### 2. 时间同步机制
- 所有TrackWidget共享相同的：
  - `pixels_per_beat`: 每拍像素数
  - `bpm`: BPM值
  - `playhead_time`: 播放头时间
- 音符的x坐标计算：`x = 100 + start_beats * pixels_per_beat`
- 所有轨道的时间轴完全同步

### 实现步骤

1. **创建TrackWidget类**
   - 继承QGraphicsItemGroup
   - 包含header、content、line三个子元素
   - 管理该轨道的所有音符块

2. **修改GridSequenceWidget**
   - 维护TrackWidget列表
   - 每个轨道对应一个TrackWidget
   - 添加/删除轨道时，创建/删除对应的TrackWidget

3. **音符管理**
   - 每个TrackWidget只管理自己轨道的音符
   - 音符块直接添加到TrackWidget的content区域
   - 使用相对坐标（相对于TrackWidget）

4. **时间同步**
   - 所有TrackWidget共享pixels_per_beat和bpm
   - 缩放时，更新所有TrackWidget的pixels_per_beat
   - 播放时，所有TrackWidget共享playhead位置

### 优势
1. **清晰的职责分离**：每个轨道独立管理
2. **易于扩展**：可以轻松添加轨道高度调整等功能
3. **性能优化**：只更新变化的轨道
4. **代码维护性**：逻辑更清晰，易于调试

